// Ensure your provider is set correctly (e.g., postgresql)
datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ===========================================
// MODEL 1: USER 
// Stores user credentials, organization info, and request limits
// ===========================================
model User {
  id               String    @id @default(uuid())
  // Authentication Data
  email            String    @unique
  passwordHash     String   
  name             String?   // User's display name
  // Organization Data from specs
  organizationName String?  
  inn              String?  
  phone            String?
  
  // MVP Trial Logic
  plan             String    @default("trial") // "trial", "start", "optimal", "profi"
  analysesRemaining Int     @default(3)       // Counter for reports left in current period/trial
  planStartDate    DateTime? // Optional: tracking to reset limits monthly
  role             String    @default("user") // "user" | "admin"
  
  // Legacy fields (keeping for compatibility)
  requestsLimit    Int       @default(50) // Starting limit
  requestsUsed     Int       @default(0)  // Used requests
  isEmailVerified  Boolean   @default(false)
  
  // Email Verification
  emailVerificationToken   String?
  emailVerificationExpires DateTime?
  
  // Password Reset
  passwordResetToken       String?
  passwordResetExpires     DateTime?
  
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relationship to Archive
  analyses         Analysis[]
  payments         Payment[]
}

// ===========================================
// MODEL 2: ANALYSIS (The Archive)
// Stores saved company reports
// ===========================================
model Analysis {
  id          String   @id @default(uuid())
  // Link to User
  userId      String   
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Report Data
  companyName String
  companyInn  String?
  reportText  String
  
  // First Contact Example (generated once, cached)
  firstContactExample String?
  
  // "Trash" functionality
  isDeleted   Boolean  @default(false) // true = in trash (корзина)
  
  // Non-target client qualification
  isNonTargetClient Boolean  @default(false) // true = non-target client (нецелевой клиент)
  
  // Credits used for this analysis
  creditsUsed Int      @default(1)
  
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([createdAt])
}

model Payment {
  id            String   @id @default(uuid())
  userId        String
  amount        Float
  currency      String   @default("RUB")
  status        String
  paymentId     String   @unique
  planName      String
  analysesCount Int
  metadata      Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([paymentId])
}



